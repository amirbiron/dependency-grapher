services:
  # API Server
  - type: web
    name: dependency-grapher-api
    env: python
    region: oregon
    plan: free
    buildCommand: pip install -r requirements.txt && pip install -r requirements-api.txt
    startCommand: gunicorn api.app:app --workers 2 --threads 4 --timeout 120 --bind 0.0.0.0:$PORT
    envVars:
      - key: FLASK_ENV
        value: production
      - key: FLASK_DEBUG
        value: False
      - key: MONGODB_URI
        sync: false  # Set in Render dashboard
      - key: DATABASE_NAME
        value: dependency_grapher
      - key: SECRET_KEY
        generateValue: true

  # Frontend (Static Site)
  - type: web
    name: dependency-grapher-frontend
    env: static
    region: oregon
    plan: free
    rootDir: frontend
    buildCommand: npm install && npm run build
    staticPublishPath: build
    envVars:
      # Build-time env for React (Create React App)
      - key: REACT_APP_API_URL
        value: https://dependency-grapher-api.onrender.com
    routes:
      # SPA fallback (React Router / direct deep links)
      - type: rewrite
        source: /*
        destination: /index.html
